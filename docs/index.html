<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GeoFilter ‚Äî GPKG Viewer</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Fraunces:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
<style>
:root {
  --bg:      #0d0f12;
  --panel:   #12151a;
  --panel2:  #181c23;
  --panel3:  #1e232c;
  --border:  #232830;
  --border2: #2b3140;
  --accent:  #c8f530;
  --accent2: #30f5c8;
  --text:    #dde2e8;
  --muted:   #546070;
  --danger:  #f04f30;
  --sz: 11px;
  /* SVG tree colors (theme-aware) */
  --svg-bg:    #0d0f12;
  --svg-grid:  #191e28;
  --svg-hdr:   #2a3445;
  --svg-edge:  #1e2530;
  --node-int:  #171c25;
  --node-root: #111620;
  --lbl-leaf:  #cdd8e8;
  --lbl-int:   #6a7e94;
  --cnt-clr:   #344455;
}
html[data-theme="light"]:root {
  --bg:      #f2f4f7;
  --panel:   #ffffff;
  --panel2:  #f7f8fa;
  --panel3:  #eef0f4;
  --border:  #dde1e8;
  --border2: #c8cfd9;
  --accent:  #4a7c00;
  --accent2: #007a64;
  --text:    #1a2030;
  --muted:   #7a8898;
  --danger:  #d0341a;
  --sz: 11px;
  --svg-bg:    #f2f4f7;
  --svg-grid:  #e0e4ec;
  --svg-hdr:   #a0aab8;
  --svg-edge:  #d8dce8;
  --node-int:  #e8ecf4;
  --node-root: #dde3ef;
  --lbl-leaf:  #1a2030;
  --lbl-int:   #4a5870;
  --cnt-clr:   #7a8898;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'JetBrains Mono',monospace;font-size:var(--sz);background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;user-select:none}

/* Header */
header{display:flex;align-items:center;gap:8px;padding:0 10px;border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;height:32px}
header h1{font-family:'Fraunces',serif;font-size:.95rem;font-weight:600;color:var(--accent);letter-spacing:-.02em}
header .tag{font-size:.6rem;color:var(--muted);padding:1px 4px;border:1px solid var(--border2);border-radius:2px}
.status-bar{margin-left:auto;font-size:.65rem;color:var(--muted);max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.status-bar.active{color:var(--accent2)}

/* App body */
.app-body{display:flex;flex:1;overflow:hidden}

/* Col 1 ‚Äì sidebar */
.sidebar{width:190px;min-width:120px;max-width:400px;flex-shrink:0;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative}
.sidebar-content{flex:1;overflow-y:auto;overflow-x:hidden;padding:5px;display:flex;flex-direction:column;gap:5px;min-height:0}
.sidebar-content::-webkit-scrollbar{width:3px}
.sidebar-content::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
#colSection{display:flex;flex-direction:column;flex:1;min-height:0}
.col-list{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-height:0}
.col-list::-webkit-scrollbar{width:3px}
.col-list::-webkit-scrollbar-thumb{background:var(--border2)}

/* Col 2 ‚Äì filter panel */
.filter-panel-col{width:220px;min-width:150px;max-width:420px;flex-shrink:0;background:var(--panel);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative}
.filter-panel-col-head{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;border-bottom:1px solid var(--border);flex-shrink:0;gap:4px}
.fp-title{font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted)}
.filter-panel-col-actions{display:flex;gap:3px;align-items:center}
.filter-panel-col-body{flex:1;overflow-y:auto;overflow-x:hidden;padding:4px;display:flex;flex-direction:column;gap:4px;min-height:0}
.filter-panel-col-body::-webkit-scrollbar{width:3px}
.filter-panel-col-body::-webkit-scrollbar-thumb{background:var(--border2)}
.filter-panel-col-foot{display:flex;align-items:center;gap:5px;padding:4px 6px;border-top:1px solid var(--border);flex-shrink:0}
.result-info{font-size:.65rem;color:var(--muted)}
.result-info strong{color:var(--accent)}
.no-filters-msg{font-size:.65rem;color:var(--muted);padding:10px 4px;line-height:1.6;text-align:center}

/* Filter cards */
.fcard{background:var(--panel2);border:1px solid var(--border2);border-radius:3px;flex-shrink:0}
.fcard-head{display:flex;align-items:center;padding:3px 5px;border-bottom:1px solid var(--border);gap:4px}
.fcard-colname{flex:1;font-size:.68rem;font-weight:600;color:var(--accent2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fcard-colname.num{color:var(--accent)}
.type-dot{width:5px;height:5px;border-radius:50%;background:var(--accent2);flex-shrink:0}
.type-dot.num{background:var(--accent)}
.fcard-remove{cursor:pointer;color:var(--muted);font-size:.9rem;line-height:1;padding:0 1px;transition:color .12s}
.fcard-remove:hover{color:var(--danger)}
.fcard-body{padding:4px 5px}
.range-inputs{display:flex;align-items:center;gap:3px}
.range-inputs input[type=number]{flex:1;min-width:0;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:inherit;font-size:.68rem;padding:2px 4px;border-radius:2px;outline:none;height:20px}
.range-inputs input[type=number]:focus{border-color:var(--accent)}
.range-inputs span{color:var(--muted);font-size:.65rem;flex-shrink:0}
.ms-trigger{display:flex;align-items:center;gap:3px;padding:0 5px;height:20px;background:var(--bg);border:1px solid var(--border2);border-radius:2px;cursor:pointer;font-size:.67rem;color:var(--text);width:100%;overflow:hidden}
.ms-trigger:hover{border-color:var(--accent2)}
.ms-trigger .ms-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;min-width:0}
.ms-trigger svg{flex-shrink:0}
.ms-selected-preview{margin-top:3px;display:flex;flex-wrap:wrap;gap:2px}
.ms-val-tag{background:rgba(48,245,200,.12);border:1px solid rgba(48,245,200,.25);color:var(--accent2);font-size:.6rem;padding:0 3px;border-radius:2px;max-width:100%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ms-val-tag.more{background:rgba(90,96,114,.15);border-color:var(--border2);color:var(--muted)}

/* Dropdown */
.ms-dropdown{position:fixed;z-index:2000;background:var(--panel2);border:1px solid var(--border2);border-radius:3px;box-shadow:0 8px 24px rgba(0,0,0,.6);display:none;flex-direction:column;width:240px;max-height:280px;overflow:hidden}
.ms-dropdown.open{display:flex}
.ms-dd-search{padding:4px 5px;border-bottom:1px solid var(--border);flex-shrink:0}
.ms-dd-search input{width:100%;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:inherit;font-size:.68rem;padding:3px 6px;border-radius:2px;outline:none}
.ms-dd-search input:focus{border-color:var(--accent2)}
.ms-dd-actions{display:flex;gap:3px;padding:3px 5px;border-bottom:1px solid var(--border);align-items:center;flex-shrink:0}
.ms-dd-actions button{font-family:inherit;font-size:.62rem;background:none;border:1px solid var(--border2);color:var(--muted);padding:1px 5px;border-radius:2px;cursor:pointer}
.ms-dd-actions button:hover{color:var(--accent);border-color:var(--accent)}
.ms-dd-count{font-size:.6rem;color:var(--muted);margin-left:auto}
.ms-dd-list{overflow-y:auto;flex:1;min-height:0}
.ms-dd-list::-webkit-scrollbar{width:3px}
.ms-dd-list::-webkit-scrollbar-thumb{background:var(--border2)}
.ms-dd-list label{display:flex;align-items:center;gap:6px;padding:3px 7px;font-size:.68rem;cursor:pointer;transition:background .1s;word-break:break-all}
.ms-dd-list label:hover{background:var(--border)}
.ms-dd-list input[type=checkbox]{accent-color:var(--accent);flex-shrink:0}

/* Buttons */
.btn-sm{font-family:inherit;font-size:.62rem;padding:2px 6px;border-radius:2px;cursor:pointer;border:1px solid var(--border2);background:none;color:var(--muted);transition:color .15s,border-color .15s;white-space:nowrap}
.btn-sm:hover{color:var(--text);border-color:var(--border2)}
.btn-sm.accent{background:var(--accent);color:#0d0f12;border-color:var(--accent);font-weight:700}
.btn-sm.accent:hover{opacity:.85}
.btn-sm.danger:hover{color:var(--danger);border-color:var(--danger)}
.btn-sm.active{background:var(--panel2);color:var(--text);border-color:var(--border2)}

/* Map col */
.map-col{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;position:relative}
#map{flex:1;min-height:0;background:#0a0c0f}

/* Basemap bar */
.top-bar{display:flex;align-items:center;gap:0;padding:2px 4px;border-bottom:1px solid var(--border);background:var(--panel);flex-shrink:0;flex-wrap:wrap;row-gap:2px}
.basemap-btn{font-family:inherit;font-size:.6rem;padding:2px 7px;background:none;border:1px solid var(--border2);color:var(--muted);cursor:pointer;transition:all .15s;border-radius:0;margin-right:-1px;height:22px}
.basemap-btn:first-of-type{border-radius:2px 0 0 2px}
.basemap-btn.bm-last{border-radius:0 2px 2px 0;margin-right:6px}
.basemap-btn.active{background:var(--panel2);color:var(--text);border-color:var(--accent2);z-index:1}
.basemap-btn:hover:not(.active){color:var(--text)}
.top-bar-sep{width:1px;height:18px;background:var(--border2);margin:0 4px}

/* Color picker row */
.color-row{display:flex;align-items:center;gap:5px}
.color-row label{font-size:.6rem;color:var(--muted)}
input[type=color].geo-color{width:22px;height:22px;border:1px solid var(--border2);border-radius:2px;cursor:pointer;padding:1px;background:var(--panel2)}
.opacity-row{display:flex;align-items:center;gap:4px}
.opacity-row label{font-size:.6rem;color:var(--muted)}
input[type=range].op-slider{width:60px;accent-color:var(--accent);cursor:pointer}
.op-val{font-size:.6rem;color:var(--muted);min-width:22px}

/* Distribution panel */
.dist-panel{position:absolute;bottom:0;left:0;right:0;background:var(--panel);border-top:1px solid var(--border);display:flex;flex-direction:column;z-index:500}
.dist-panel.hidden{display:none}
.dist-panel-head{display:flex;align-items:center;gap:6px;padding:3px 8px;border-bottom:1px solid var(--border);flex-shrink:0}
.dist-panel-title{font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted)}
.dist-panel-body{display:flex;overflow-x:auto;overflow-y:hidden;flex:1;gap:0;min-height:0;padding:0}
.dist-panel-body::-webkit-scrollbar{height:3px}
.dist-panel-body::-webkit-scrollbar-thumb{background:var(--border2)}
.dist-resize{height:5px;cursor:row-resize;background:transparent;flex-shrink:0}
.dist-resize:hover{background:var(--accent);opacity:.4}
.plot-wrap{flex-shrink:0;border-right:1px solid var(--border);position:relative;margin-right:8px}
.plot-wrap:last-child{margin-right:0}
.plot-wrap canvas{display:block}
.plot-label{position:absolute;bottom:4px;left:0;right:0;text-align:center;font-size:.58rem;color:var(--muted);pointer-events:none}

/* Column picker dist checkbox */
.col-item-dist{font-size:.58rem;cursor:pointer;color:var(--muted);flex-shrink:0;margin-left:2px;padding:0 1px;border:1px solid transparent;border-radius:2px;transition:all .1s;line-height:1}
.col-item-dist:hover{color:var(--accent2);border-color:var(--accent2)}
.col-item-dist.active{color:var(--accent2);border-color:var(--accent2);background:rgba(48,245,200,.1)}

/* Sidebar shared */
.upload-zone{border:1px dashed var(--border2);border-radius:3px;padding:10px 6px;text-align:center;cursor:pointer;transition:all .2s;position:relative;flex-shrink:0}
.upload-zone:hover,.upload-zone.drag{border-color:var(--accent);background:rgba(200,245,48,.04)}
.upload-zone input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
.upload-zone .icon{font-size:1.1rem;margin-bottom:3px}
.upload-zone p{font-size:.6rem;color:var(--muted)}
.upload-zone strong{color:var(--accent);font-size:.65rem;display:block;margin-bottom:1px}
.section-title{font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding-bottom:3px;border-bottom:1px solid var(--border);margin-bottom:3px;flex-shrink:0}
.layer-select{width:100%;background:var(--panel2);border:1px solid var(--border2);color:var(--text);font-family:inherit;font-size:.68rem;padding:3px 5px;border-radius:2px;cursor:pointer;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23546070' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 5px center;flex-shrink:0}
.layer-select:focus{border-color:var(--accent)}
.col-item{display:flex;align-items:center;gap:4px;padding:2px 3px;border-radius:2px;cursor:pointer;font-size:.67rem;transition:background .1s}
.col-item:hover{background:var(--panel3)}
.col-item input[type=checkbox]{accent-color:var(--accent);cursor:pointer;flex-shrink:0;width:11px;height:11px}
.col-item .col-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.col-item .type-badge{font-size:.55rem;padding:0 3px;border-radius:2px;background:var(--bg);color:var(--muted);flex-shrink:0}
.col-item .type-badge.num{color:var(--accent)}
.no-data{padding:10px 4px;text-align:center;color:var(--muted);font-size:.67rem;line-height:1.7;flex-shrink:0}
.debug-info{font-size:.58rem;color:var(--muted);padding:3px 5px;background:var(--panel2);border:1px solid var(--border);border-radius:2px;word-break:break-all;line-height:1.5;flex-shrink:0}

/* Resize handles */
.resize-handle-v{position:absolute;right:-3px;top:0;bottom:0;width:6px;cursor:col-resize;z-index:10;background:transparent}
.resize-handle-v:hover,.resize-handle-v.active{background:var(--accent);opacity:.4;border-radius:3px}

/* Overlay */
.overlay{position:fixed;inset:0;background:rgba(13,15,18,.88);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(3px)}
.overlay.hidden{display:none}
.spinner{text-align:center;color:var(--accent);font-size:.8rem}
.spinner-ring{width:30px;height:30px;border:2px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Hover tooltip */
.geo-tooltip{position:fixed;z-index:1500;background:var(--panel2);border:1px solid var(--border2);border-radius:4px;box-shadow:0 6px 20px rgba(0,0,0,.7);padding:6px 8px;font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text);pointer-events:none;display:none;max-width:440px;min-width:200px;max-height:320px;overflow-y:auto}
.geo-tooltip table{border-collapse:collapse;width:100%}
.geo-tooltip td{padding:1px 0;vertical-align:top}
.geo-tooltip td:first-child{color:var(--muted);padding-right:8px;white-space:nowrap;max-width:160px;overflow:hidden;text-overflow:ellipsis}
.geo-tooltip td:last-child{color:var(--text);word-break:break-word;max-width:260px}

/* ‚ïê‚ïê Color Tree Panel ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
.tree-panel{width:300px;min-width:200px;max-width:600px;flex-shrink:0;background:var(--panel);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;position:relative}
.tree-panel-head{display:flex;align-items:center;gap:5px;padding:4px 6px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;row-gap:3px}
.tree-panel-title{font-size:.6rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);flex-shrink:0}

/* Column builder strip */
.tree-builder{padding:5px 6px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:4px}
.tree-builder-hint{font-size:.57rem;color:var(--muted)}
.tree-builder-levels{display:flex;flex-wrap:wrap;gap:3px;min-height:16px}
.tree-level-chip{display:flex;align-items:center;gap:3px;background:var(--panel3);border:1px solid var(--border2);border-radius:10px;padding:1px 6px 1px 8px;font-size:.63rem;color:var(--text);cursor:default}
.tree-level-chip .lc-num{font-size:.55rem;color:var(--accent2);margin-right:2px}
.tree-level-chip .lc-rm{cursor:pointer;color:var(--muted);font-size:.75rem;line-height:1;padding:0 1px;transition:color .12s}
.tree-level-chip .lc-rm:hover{color:var(--danger)}
.tree-add-row{display:flex;gap:3px}
.tree-col-select{flex:1;background:var(--panel2);border:1px solid var(--border2);color:var(--text);font-family:inherit;font-size:.67rem;padding:2px 4px;border-radius:2px;cursor:pointer;outline:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 12 12'%3E%3Cpath fill='%23546070' d='M6 8L1 3h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 4px center}
.tree-col-select:focus{border-color:var(--accent)}
.tree-warn{font-size:.57rem;color:var(--danger)}

/* SVG canvas area */
.tree-svg-wrap{flex:1;overflow:auto;min-height:0;position:relative;cursor:grab}
.tree-svg-wrap:active{cursor:grabbing}
.tree-svg-wrap::-webkit-scrollbar{width:4px;height:4px}
.tree-svg-wrap::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
#treeSvg{display:block;font-family:'JetBrains Mono',monospace}
#treeSvg .node-circle{cursor:pointer;transition:r .15s}
#treeSvg .node-circle:hover{filter:brightness(1.3)}
#treeSvg .node-label{font-size:9px;fill:#8a98aa;pointer-events:none;dominant-baseline:central}
#treeSvg .node-label.leaf{fill:#c8d8e8}
#treeSvg .node-count{font-size:8px;fill:#546070;pointer-events:none}
#treeSvg .edge{fill:none;stroke-linecap:round}
#treeSvg .edge-label{font-size:8px;fill:#546070;pointer-events:none}
#treeSvg .depth-label{font-size:8px;fill:#2b3140;dominant-baseline:middle}
#treeSvg .col-divider{stroke:#1e232c;stroke-dasharray:3 4}
.tree-empty-msg{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;color:var(--muted);text-align:center;padding:20px;pointer-events:none}

/* Legend */
.tree-legend-bar{padding:4px 6px;border-top:1px solid var(--border);flex-shrink:0;display:flex;flex-direction:column;gap:3px}
.tree-legend-title{font-size:.57rem;color:var(--muted)}
.tree-legend-items{display:flex;flex-wrap:wrap;gap:3px;max-height:68px;overflow-y:auto}
.tree-legend-items::-webkit-scrollbar{height:2px;width:2px}
.tree-legend-items::-webkit-scrollbar-thumb{background:var(--border2)}
.tli{display:flex;align-items:center;gap:3px;font-size:.58rem;color:var(--muted);max-width:120px;cursor:pointer;padding:1px 3px;border-radius:2px;transition:background .1s}
.tli:hover{background:var(--panel2)}
.tli-sw{width:9px;height:9px;border-radius:2px;flex-shrink:0}
.tli-lbl{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tli-n{margin-left:auto;flex-shrink:0;color:#2b3140}

/* Theme transition */
*, *::before, *::after { transition: background-color .18s, border-color .18s, color .1s; }
/* but NOT SVG children (too slow) */
svg *, canvas { transition: none !important; }

/* Theme toggle button in header */
.theme-toggle{margin-left:auto;display:flex;align-items:center;gap:5px}
.theme-btn{font-family:inherit;font-size:.6rem;padding:2px 6px;border-radius:10px;cursor:pointer;border:1px solid var(--border2);background:none;color:var(--muted);transition:all .15s}
.theme-btn.active{background:var(--accent);color:#0d0f12;border-color:var(--accent);font-weight:700}
html[data-theme="light"] .theme-btn.active{color:#fff;background:var(--accent2);border-color:var(--accent2)}

/* Leaflet light mode adjustments */
html[data-theme="light"] .leaflet-container { background: #e8ecf4; }
html[data-theme="light"] .leaflet-bar a { background: var(--panel); color: var(--text); border-color: var(--border); }
html[data-theme="light"] .leaflet-popup-content-wrapper, html[data-theme="light"] .leaflet-popup-tip { background: var(--panel); color: var(--text); }
/* Disclaimer badge */
.disclaimer{position:fixed;bottom:6px;right:8px;z-index:2000;font-family:'JetBrains Mono',monospace;font-size:.53rem;color:var(--muted);background:var(--panel);border:1px solid var(--border);border-radius:3px;padding:2px 7px;opacity:.65;pointer-events:none;line-height:1.5;text-align:right}
</style>
<body>

<div class="overlay" id="overlay"><div class="spinner"><div class="spinner-ring"></div><div id="overlay-msg">Loading‚Ä¶</div></div></div>
<div class="geo-tooltip" id="geoTooltip"></div>
<div class="disclaimer">Built with AI assistance. <br>Verify outputs independently.</div>

<!-- Singleton dropdown -->
<div class="ms-dropdown" id="msDropdown">
  <div class="ms-dd-search"><input type="text" placeholder="Search values‚Ä¶" id="msSearch"></div>
  <div class="ms-dd-actions"><button id="msAll">All</button><button id="msNone">None</button><span class="ms-dd-count" id="msCount"></span></div>
  <div class="ms-dd-list" id="msList"></div>
</div>

<header>
  <h1>GeoFilter</h1><span class="tag">.gpkg</span>
  <div class="status-bar" id="statusBar">No file loaded</div>
  <div class="theme-toggle">
    <button class="theme-btn active" data-theme="dark" title="Dark theme">‚óë Dark</button>
    <button class="theme-btn" data-theme="light" title="Light theme">‚óê Light</button>
  </div>
</header>

<div class="app-body">

  <!-- Col 1: sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-content">
      <div class="upload-zone" id="uploadZone">
        <input type="file" id="fileInput" accept=".gpkg"/>
        <div class="icon">üì¶</div><strong>Drop .gpkg here</strong><p>or click to browse</p>
      </div>
      <div class="no-data" id="noDataMsg">Load a .gpkg file to start.</div>
      <div id="layerSection" style="display:none;flex-shrink:0">
        <div class="section-title">Layer</div>
        <select class="layer-select" id="layerSelect"></select>
      </div>
      <div id="colSection" style="display:none">
        <div class="section-title">Columns ‚Äî ‚úì filter / üìä plot</div>
        <div class="col-list" id="colList"></div>
      </div>
      <div id="debugInfo" class="debug-info" style="display:none"></div>
    </div>
    <div class="resize-handle-v" id="rHandleV1"></div>
  </div>

  <!-- Col 2: filter panel -->
  <div class="filter-panel-col" id="filterPanelCol">
    <div class="filter-panel-col-head">
      <span class="fp-title">Active Filters</span>
      <div class="filter-panel-col-actions">
        <button class="btn-sm danger" id="resetBtn" style="display:none">‚úï Reset</button>
        <button class="btn-sm accent" id="applyBtn">‚ö° Apply</button>
      </div>
    </div>
    <div class="filter-panel-col-body" id="filterCards">
      <div class="no-filters-msg" id="noFiltersMsg">Check columns on<br>the left to filter.</div>
    </div>
    <div class="filter-panel-col-foot"><span class="result-info" id="resultInfo"></span></div>
    <div class="resize-handle-v" id="rHandleV2"></div>
  </div>

  <!-- Col 3: map + dist panel -->
  <div class="map-col">
    <div class="top-bar">
      <!-- Basemap buttons -->
      <button class="basemap-btn active" data-layer="carto-dark">Carto Dark</button>
      <button class="basemap-btn" data-layer="osm">OSM</button>
      <button class="basemap-btn" data-layer="carto-light">Carto Light</button>
      <button class="basemap-btn" data-layer="wms-sachsen">Sachsen DOP</button>
      <button class="basemap-btn bm-last" data-layer="none">None</button>
      <div class="top-bar-sep"></div>
      <!-- Color picker -->
      <div class="color-row">
        <label>Fill</label>
        <input type="color" class="geo-color" id="geoColor" value="#c8f530">
        <label>Stroke</label>
        <input type="color" class="geo-color" id="geoStroke" value="#c8f530">
      </div>
      <div class="top-bar-sep"></div>
      <div class="opacity-row">
        <label>Opacity</label>
        <input type="range" class="op-slider" id="fillOpacity" min="0" max="100" value="20">
        <span class="op-val" id="opVal">20%</span>
      </div>
    </div>
    <div id="map"></div>

    <!-- Distribution panel -->
    <div class="dist-panel hidden" id="distPanel">
      <div class="dist-resize" id="distResize"></div>
      <div class="dist-panel-head">
        <span class="dist-panel-title">Distribution</span>
        <div style="display:flex;gap:4px;align-items:center;margin-left:6px">
          <button class="btn-sm" id="plotTypeBox" title="Boxplot">Box</button>
          <button class="btn-sm" id="plotTypeViolin" title="Violin">Violin</button>
        </div>
        <button class="btn-sm danger" id="closeDistBtn" style="margin-left:auto">‚úï</button>
      </div>
      <div class="dist-panel-body" id="distBody"></div>
    </div>
  </div><!-- /map-col -->

  <!-- Col 4: Color Tree -->
  <div class="tree-panel" id="treePanel">
    <div class="tree-panel-head">
      <span class="tree-panel-title">Color Tree</span>
      <div style="display:flex;gap:2px;align-items:center;margin-left:6px">
        <button class="btn-sm active" id="treeOrientH" title="Horizontal layout">‚áî</button>
        <button class="btn-sm" id="treeOrientV" title="Vertical layout">‚áï</button>
      </div>
      <div style="display:flex;gap:3px;margin-left:auto;align-items:center">
        <button class="btn-sm" id="treeFitBtn" title="Fit to view" style="display:none">‚ä° Fit</button>
        <button class="btn-sm danger" id="treeClearBtn" style="display:none">‚úï Clear</button>
      </div>
    </div>

    <!-- Level builder -->
    <div class="tree-builder">
      <div class="tree-builder-hint">Add categorical split levels to color geometries:</div>
      <div class="tree-builder-levels" id="treeLevelList"></div>
      <div class="tree-add-row">
        <select class="tree-col-select" id="treeColPicker">
          <option value="">‚Äî select column ‚Äî</option>
        </select>
        <button class="btn-sm accent" id="treeAddLevelBtn">+ Split</button>
      </div>
      <div class="tree-warn" id="treeMaxValWarn"></div>
    </div>

    <!-- SVG dendrogram -->
    <div class="tree-svg-wrap" id="treeSvgWrap">
      <svg id="treeSvg"></svg>
      <div class="tree-empty-msg" id="treeEmptyMsg">Add columns above to build the color tree</div>
    </div>

    <!-- Legend -->
    <div class="tree-legend-bar" id="treeLegendBar" style="display:none">
      <div class="tree-legend-title">Leaf colors ‚Äî <span id="treeLegendCount"></span> groups</div>
      <div class="tree-legend-items" id="treeLegendItems"></div>
    </div>

    <div class="resize-handle-v" id="rHandleV3" style="left:-3px;right:auto"></div>
  </div>

</div>

<script>
/* ‚îÄ‚îÄ Globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let db = null, SQL = null;
let map, geojsonLayer = null;
let currentLayer = null, geomColumn = 'geom', layerSRID = 4326;
let projTransform = null;
let columns = [];
let activeFilters = {};    // colName ‚Üí {type,min,max,values,all}
let currentFeatures = [];  // last rendered features for distribution
let distCols = new Set();  // columns selected for distribution
let plotType = 'box';      // 'box' | 'violin'
let geoFill = '#c8f530', geoStroke = '#c8f530', geoFillOpacity = 0.2;

// Multi-select dropdown state
let activeDropdownColName = null;
const msTriggerMap = {};   // colName ‚Üí {trigger, preview}

/* ‚îÄ‚îÄ Map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
map = L.map('map', { preferCanvas: true });
map.setView([20, 0], 2);

const baseLayers = {
  'carto-dark':  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',  { attribution:'¬© OpenStreetMap ¬© CARTO', maxZoom:20 }),
  'osm':         L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',             { attribution:'¬© OpenStreetMap contributors', maxZoom:19 }),
  'carto-light': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution:'¬© OpenStreetMap ¬© CARTO', maxZoom:20 }),
  'wms-sachsen': L.tileLayer.wms('https://geodienste.sachsen.de/wms_geosn_dop-rgb/guest', { layers:'sn_dop_020', format:'image/png', transparent:false, attribution:'¬© GeoSN Sachsen', maxZoom:20 }),
  'none': null
};
baseLayers['carto-dark'].addTo(map);
let currentBasemap = 'carto-dark';

document.querySelectorAll('.basemap-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const key = btn.dataset.layer;
    if (key === currentBasemap) return;
    if (baseLayers[currentBasemap]) map.removeLayer(baseLayers[currentBasemap]);
    if (baseLayers[key]) baseLayers[key].addTo(map);
    if (geojsonLayer) geojsonLayer.bringToFront();
    currentBasemap = key;
    document.querySelectorAll('.basemap-btn').forEach(b => b.classList.toggle('active', b.dataset.layer === key));
  });
});

/* ‚îÄ‚îÄ Theme toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.querySelectorAll('.theme-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const theme = btn.dataset.theme;
    document.documentElement.setAttribute('data-theme', theme === 'dark' ? '' : 'light');
    document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('active', b.dataset.theme === theme));
    // Update SVG background if tree is visible
    if (treeRoot) drawDendrogram();
  });
});
document.getElementById('geoColor').addEventListener('input', e => { geoFill = e.target.value; redrawStyle(); });
document.getElementById('geoStroke').addEventListener('input', e => { geoStroke = e.target.value; redrawStyle(); });
document.getElementById('fillOpacity').addEventListener('input', e => {
  geoFillOpacity = parseInt(e.target.value) / 100;
  document.getElementById('opVal').textContent = e.target.value + '%';
  redrawStyle();
});
function redrawStyle() {
  if (!geojsonLayer) return;
  if (featureColorMap.size > 0) {
    // Re-apply tree coloring (opacity may have changed)
    applyTreeColoring();
  } else {
    geojsonLayer.setStyle({ color: geoStroke, fillColor: geoFill, fillOpacity: geoFillOpacity, weight: 1.5, opacity: 0.9 });
  }
}

/* ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const tooltip = document.getElementById('geoTooltip');
function showTooltip(props, x, y) {
  const rows = Object.entries(props).map(([k,v]) =>
    `<tr><td>${escHtml(k)}</td><td>${escHtml(String(v??''))}</td></tr>`).join('');
  tooltip.innerHTML = `<table>${rows}</table>`;
  tooltip.style.display = 'block';
  positionTooltip(x, y);
}
function positionTooltip(x, y) {
  const W = window.innerWidth, H = window.innerHeight;
  const tw = tooltip.offsetWidth, th = tooltip.offsetHeight;
  let left = x + 14, top = y + 14;
  if (left + tw > W - 10) left = x - tw - 10;
  if (top + th > H - 10) top = y - th - 10;
  tooltip.style.left = left + 'px'; tooltip.style.top = top + 'px';
}
function hideTooltip() { tooltip.style.display = 'none'; }

/* ‚îÄ‚îÄ SQL.js ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
showOverlay('Initializing‚Ä¶');
initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}` })
  .then(s => { SQL = s; hideOverlay(); })
  .catch(e => showOverlay('SQL.js failed: ' + e.message));

/* ‚îÄ‚îÄ UI helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function showOverlay(msg) { document.getElementById('overlay-msg').textContent = msg||'Loading‚Ä¶'; document.getElementById('overlay').classList.remove('hidden'); }
function hideOverlay() { document.getElementById('overlay').classList.add('hidden'); }
function setStatus(txt, active) { const el=document.getElementById('statusBar'); el.textContent=txt; el.className='status-bar'+(active?' active':''); }
function setDebug(lines) { const el=document.getElementById('debugInfo'); if(!lines||!lines.length){el.style.display='none';return;} el.style.display='block'; el.innerHTML=lines.map(l=>escHtml(l)).join('<br>'); }

/* ‚îÄ‚îÄ Resize handles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function makeResizeV(handleId, targetEl) {
  const h = document.getElementById(handleId);
  let dragging=false, startX, startW;
  h.addEventListener('mousedown', e => { dragging=true; startX=e.clientX; startW=targetEl.offsetWidth; h.classList.add('active'); document.body.style.cursor='col-resize'; e.preventDefault(); });
  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const min=parseInt(targetEl.style.minWidth)||120, max=parseInt(targetEl.style.maxWidth)||420;
    targetEl.style.width = Math.min(max, Math.max(min, startW+(e.clientX-startX)))+'px';
  });
  document.addEventListener('mouseup', () => { if(!dragging)return; dragging=false; h.classList.remove('active'); document.body.style.cursor=''; map.invalidateSize(); });
}
makeResizeV('rHandleV1', document.getElementById('sidebar'));
makeResizeV('rHandleV2', document.getElementById('filterPanelCol'));

// Distribution panel vertical resize
(function() {
  const handle = document.getElementById('distResize');
  const panel  = document.getElementById('distPanel');
  let dragging=false, startY, startH;
  handle.addEventListener('mousedown', e => { dragging=true; startY=e.clientY; startH=panel.offsetHeight; document.body.style.cursor='row-resize'; e.preventDefault(); });
  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const h = Math.min(500, Math.max(80, startH - (e.clientY - startY)));
    panel.style.height = h+'px';
    renderDistribution();
  });
  document.addEventListener('mouseup', () => { if(!dragging)return; dragging=false; document.body.style.cursor=''; });
})();

/* ‚îÄ‚îÄ Distribution panel controls ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let distPanelHeight = 160;
document.getElementById('closeDistBtn').addEventListener('click', () => {
  distCols.clear();
  document.getElementById('distPanel').classList.add('hidden');
  document.querySelectorAll('.col-item-dist.active').forEach(el => el.classList.remove('active'));
});
document.getElementById('plotTypeBox').addEventListener('click', () => { plotType='box'; renderDistribution(); });
document.getElementById('plotTypeViolin').addEventListener('click', () => { plotType='violin'; renderDistribution(); });

/* ‚îÄ‚îÄ Dropdown singleton ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const msDropdown = document.getElementById('msDropdown');
const msSearch   = document.getElementById('msSearch');
const msList     = document.getElementById('msList');
const msCount    = document.getElementById('msCount');

document.getElementById('msAll').addEventListener('click', () => { msList.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=true); syncDropdown(); });
document.getElementById('msNone').addEventListener('click', () => { msList.querySelectorAll('input[type=checkbox]').forEach(c=>c.checked=false); syncDropdown(); });
msSearch.addEventListener('input', () => {
  const q = msSearch.value.toLowerCase();
  msList.querySelectorAll('label').forEach(lbl => lbl.style.display = lbl.textContent.toLowerCase().includes(q)?'':'none');
});
msList.addEventListener('change', syncDropdown);

function syncDropdown() {
  if (!activeDropdownColName) return;
  const f = activeFilters[activeDropdownColName]; if (!f) return;
  const sel = new Set(); msList.querySelectorAll('input[type=checkbox]:checked').forEach(c => sel.add(c.dataset.val));
  f.values = sel; updateCardPreview(activeDropdownColName);
}
function openDropdown(colName, anchorEl) {
  if (activeDropdownColName === colName) { closeDropdown(); return; }
  activeDropdownColName = colName;
  const f = activeFilters[colName]; if (!f||f.type!=='text') return;
  msSearch.value = '';
  msList.innerHTML = f.all.map(v => `<label><input type="checkbox" data-val="${escAttr(v)}" ${f.values.has(v)?'checked':''}>${escHtml(v)||'<em style="opacity:.4">(empty)</em>'}</label>`).join('');
  msCount.textContent = f.all.length+' values';
  const rect = anchorEl.getBoundingClientRect();
  const dropW = 240;
  let left = rect.left;
  if (left+dropW > window.innerWidth-8) left = window.innerWidth-dropW-8;
  msDropdown.style.left = left+'px'; msDropdown.style.top = (rect.bottom+2)+'px'; msDropdown.style.width = dropW+'px';
  msDropdown.classList.add('open');
}
function closeDropdown() { msDropdown.classList.remove('open'); activeDropdownColName=null; }
document.addEventListener('mousedown', e => { if(!msDropdown.contains(e.target)&&!e.target.closest('.ms-trigger')) closeDropdown(); });

function updateCardPreview(colName) {
  const f = activeFilters[colName]; const entry = msTriggerMap[colName]; if (!f||!entry) return;
  const total=f.all.length, sel=f.values.size;
  const textEl = entry.trigger.querySelector('.ms-text');
  if (sel===0) textEl.textContent='(none selected)';
  else if (sel===total) textEl.textContent=`All (${total})`;
  else textEl.textContent=`${sel} / ${total} selected`;
  if (entry.preview) {
    entry.preview.innerHTML='';
    if (sel===0||sel===total) return;
    const vals=[...f.values]; const show=vals.slice(0,8);
    show.forEach(v => { const tag=document.createElement('span'); tag.className='ms-val-tag'; tag.textContent=v||'(empty)'; tag.title=v; entry.preview.appendChild(tag); });
    if (vals.length>8) { const more=document.createElement('span'); more.className='ms-val-tag more'; more.textContent=`+${vals.length-8} more`; entry.preview.appendChild(more); }
  }
}

/* ‚îÄ‚îÄ File upload ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const uploadZone = document.getElementById('uploadZone');
const fileInput  = document.getElementById('fileInput');
uploadZone.addEventListener('dragover', e=>{e.preventDefault();uploadZone.classList.add('drag');});
uploadZone.addEventListener('dragleave', ()=>uploadZone.classList.remove('drag'));
uploadZone.addEventListener('drop', e=>{e.preventDefault();uploadZone.classList.remove('drag');const f=e.dataTransfer.files[0];if(f)loadFile(f);});
fileInput.addEventListener('change', ()=>{if(fileInput.files[0])loadFile(fileInput.files[0]);});

async function loadFile(file) {
  showOverlay('Reading file‚Ä¶');
  try {
    const buf = await file.arrayBuffer();
    showOverlay('Opening GeoPackage‚Ä¶');
    db = new SQL.Database(new Uint8Array(buf));
    const layers = getGeoPackageLayers();
    if (!layers.length) throw new Error('No geometry feature layers found.');
    populateLayerSelect(layers);
    document.getElementById('noDataMsg').style.display='none';
    document.getElementById('layerSection').style.display='block';
    setStatus(file.name+' ‚Äî '+layers.length+' layer(s)', true);
    await loadLayer(layers[0]);
  } catch(e) { hideOverlay(); alert('Error: '+e.message); console.error(e); }
}

/* ‚îÄ‚îÄ Layer discovery ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function getGeoPackageLayers() {
  try { const r=db.exec(`SELECT table_name FROM gpkg_contents WHERE data_type='features'`); if(r.length&&r[0].values.length) return r[0].values.map(v=>v[0]); } catch(e){}
  try { const r=db.exec(`SELECT DISTINCT table_name FROM gpkg_geometry_columns`); if(r.length&&r[0].values.length) return r[0].values.map(v=>v[0]); } catch(e){}
  return [];
}
function populateLayerSelect(layers) {
  const sel=document.getElementById('layerSelect');
  sel.innerHTML=layers.map(l=>`<option value="${escHtml(l)}">${escHtml(l)}</option>`).join('');
  sel.onchange=()=>loadLayer(sel.value);
}

/* ‚îÄ‚îÄ Load layer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadLayer(layerName) {
  currentLayer=layerName; columns=[]; activeFilters={}; projTransform=null; currentFeatures=[];
  distCols.clear();
  document.getElementById('distPanel').classList.add('hidden');
  closeDropdown();
  clearAllFilters(false);
  setDebug([]);
  showOverlay('Analyzing layer‚Ä¶');

  geomColumn='geom'; layerSRID=4326;
  try {
    const r=db.exec(`SELECT column_name, srs_id FROM gpkg_geometry_columns WHERE table_name='${layerName}'`);
    if(r.length&&r[0].values.length){geomColumn=r[0].values[0][0];layerSRID=Number(r[0].values[0][1]);}
  } catch(e){}

  const dbg=[`Layer: ${layerName}`,`Geom: ${geomColumn}`,`SRID: ${layerSRID}`];

  if (layerSRID&&layerSRID!==4326&&layerSRID!==0) {
    try {
      const r=db.exec(`SELECT definition FROM gpkg_spatial_ref_sys WHERE srs_id=${layerSRID} LIMIT 1`);
      if(r.length&&r[0].values.length){const def=r[0].values[0][0];if(def&&def!=='undefined'&&def.length>5){proj4.defs(`EPSG:${layerSRID}`,def);projTransform=proj4(`EPSG:${layerSRID}`,'EPSG:4326');dbg.push(`Reprojecting EPSG:${layerSRID}‚ÜíWGS84`);}}
    } catch(e){dbg.push('Proj4: '+e.message);}
  }

  const GEOM=new Set([geomColumn.toLowerCase(),'geom','geometry','the_geom','shape','wkb_geometry','ogr_geometry','geom_wgs84']);
  try {
    const info=db.exec(`PRAGMA table_info("${layerName}")`);
    if(!info.length) throw new Error('No table info');
    columns=info[0].values.filter(r=>!GEOM.has(String(r[1]).toLowerCase())).map(r=>({name:r[1],type:inferType(r[2])}));
    dbg.push(`${columns.length} columns`);
  } catch(e){hideOverlay();alert('Error: '+e.message);return;}

  renderColList();
  document.getElementById('colSection').style.display='flex';
  setDebug(dbg);
  // Reset tree state for new layer
  treeLevels=[]; treeRoot=null; featureColorMap.clear();
  renderLevelChips();
  treePopulatePicker();
  document.getElementById('treeSvg').innerHTML='';
  document.getElementById('treeEmptyMsg').style.display='flex';
  document.getElementById('treeLegendBar').style.display='none';
  document.getElementById('treeFitBtn').style.display='none';
  document.getElementById('treeClearBtn').style.display='none';
  await applyFilters();
}
function inferType(t){return t&&/INT|REAL|FLOAT|DOUBLE|NUMERIC|DECIMAL|NUMBER/i.test(t)?'number':'text';}

/* ‚îÄ‚îÄ Column list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderColList() {
  const list=document.getElementById('colList');
  // Remove old listener by replacing node
  const newList=list.cloneNode(false);
  list.parentNode.replaceChild(newList, list);

  newList.innerHTML=columns.map(c=>`
    <div class="col-item" data-col="${escAttr(c.name)}">
      <input type="checkbox" id="cc_${escAttr(c.name)}">
      <span class="col-name" title="${escHtml(c.name)}">${escHtml(c.name)}</span>
      <span class="type-badge ${c.type==='number'?'num':''}">${c.type}</span>
      ${c.type==='number'?`<span class="col-item-dist" data-distcol="${escAttr(c.name)}" title="Plot distribution">üìä</span>`:''}
    </div>
  `).join('');

  // Single delegated listener
  newList.addEventListener('click', e => {
    // Distribution plot button
    const distBtn = e.target.closest('.col-item-dist');
    if (distBtn) {
      e.stopPropagation();
      const safeId = distBtn.dataset.distcol;
      const col = columns.find(c => escAttr(c.name)===safeId);
      if (!col) return;
      if (distCols.has(col.name)) {
        distCols.delete(col.name);
        distBtn.classList.remove('active');
        if (distCols.size===0) document.getElementById('distPanel').classList.add('hidden');
        else renderDistribution();
      } else {
        distCols.add(col.name);
        distBtn.classList.add('active');
        document.getElementById('distPanel').classList.remove('hidden');
        document.getElementById('distPanel').style.height = '160px';
        renderDistribution();
      }
      return;
    }

    // Filter checkbox
    const item = e.target.closest('.col-item');
    if (!item) return;
    const safeId = item.dataset.col;
    const col = columns.find(c => escAttr(c.name)===safeId);
    if (!col) return;
    const chk = item.querySelector('input[type=checkbox]');
    if (e.target!==chk) chk.checked=!chk.checked;

    // Guard: prevent double-add if already exists
    if (chk.checked) {
      if (!document.getElementById(`fcard_${safeId}`)) addFilterCard(col.name);
    } else {
      removeFilterCard(col.name);
    }
  });
}

/* ‚îÄ‚îÄ Filter cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function clearAllFilters(keepData) {
  Object.keys(msTriggerMap).forEach(k=>delete msTriggerMap[k]);
  if(!keepData) activeFilters={};
  document.getElementById('filterCards').innerHTML='<div class="no-filters-msg" id="noFiltersMsg">Check columns on<br>the left to filter.</div>';
  document.getElementById('resetBtn').style.display='none';
  document.getElementById('resultInfo').textContent='';
  document.querySelectorAll('#colList input[type=checkbox]').forEach(c=>c.checked=false);
}
document.getElementById('resetBtn').addEventListener('click',()=>{clearAllFilters(false);applyFilters();});
function updateResetBtn(){document.getElementById('resetBtn').style.display=document.querySelectorAll('#filterCards .fcard').length?'inline-block':'none';}

function addFilterCard(colName) {
  // Guard: don't add duplicate
  const safeId=escAttr(colName);
  if (document.getElementById(`fcard_${safeId}`)) return;

  const col=columns.find(c=>c.name===colName); if(!col) return;
  const placeholder=document.getElementById('noFiltersMsg'); if(placeholder) placeholder.remove();

  const card=document.createElement('div');
  card.className='fcard'; card.id=`fcard_${safeId}`;

  if (col.type==='number') {
    let mn='',mx='';
    try{const r=db.exec(`SELECT MIN("${colName}"), MAX("${colName}") FROM "${currentLayer}"`);if(r.length){mn=r[0].values[0][0]??'';mx=r[0].values[0][1]??'';}}catch(e){}
    card.innerHTML=`
      <div class="fcard-head"><span class="type-dot num"></span><span class="fcard-colname num" title="${escHtml(colName)}">${escHtml(colName)}</span><span class="fcard-remove">√ó</span></div>
      <div class="fcard-body"><div class="range-inputs">
        <input type="number" id="rmin_${safeId}" placeholder="Min${mn!==''?' '+mn:''}" step="any">
        <span>‚Äì</span>
        <input type="number" id="rmax_${safeId}" placeholder="Max${mx!==''?' '+mx:''}" step="any">
      </div></div>`;
    activeFilters[colName]={type:'number',min:null,max:null};
    card.querySelector(`#rmin_${safeId}`).addEventListener('input',e=>{activeFilters[colName].min=e.target.value!==''?parseFloat(e.target.value):null;});
    card.querySelector(`#rmax_${safeId}`).addEventListener('input',e=>{activeFilters[colName].max=e.target.value!==''?parseFloat(e.target.value):null;});
  } else {
    let values=[];
    try{const r=db.exec(`SELECT DISTINCT "${colName}" FROM "${currentLayer}" WHERE "${colName}" IS NOT NULL ORDER BY "${colName}" LIMIT 2000`);if(r.length)values=r[0].values.map(v=>v[0]===null?'':String(v[0]));}catch(e){}
    activeFilters[colName]={type:'text',values:new Set(values),all:values};
    card.innerHTML=`
      <div class="fcard-head"><span class="type-dot"></span><span class="fcard-colname" title="${escHtml(colName)}">${escHtml(colName)}</span><span class="fcard-remove">√ó</span></div>
      <div class="fcard-body">
        <div class="ms-trigger" id="mst_${safeId}"><span class="ms-text">All (${values.length})</span><svg width="7" height="7" viewBox="0 0 8 8"><path fill="#546070" d="M4 6L0 2h8z"/></svg></div>
        <div class="ms-selected-preview" id="msprev_${safeId}"></div>
      </div>`;
    const trigger=card.querySelector(`#mst_${safeId}`);
    const preview=card.querySelector(`#msprev_${safeId}`);
    msTriggerMap[colName]={trigger,preview};
    trigger.addEventListener('click',e=>{e.stopPropagation();openDropdown(colName,trigger);});
  }

  card.querySelector('.fcard-remove').addEventListener('click',()=>{
    removeFilterCard(colName);
    const chk=document.getElementById(`cc_${safeId}`);
    if(chk) chk.checked=false;
  });
  document.getElementById('filterCards').appendChild(card);
  updateResetBtn();
}

function removeFilterCard(colName) {
  const safeId=escAttr(colName);
  const card=document.getElementById(`fcard_${safeId}`); if(card) card.remove();
  delete activeFilters[colName]; delete msTriggerMap[colName];
  if(activeDropdownColName===colName) closeDropdown();
  if(!document.querySelector('#filterCards .fcard'))
    document.getElementById('filterCards').innerHTML='<div class="no-filters-msg" id="noFiltersMsg">Check columns on<br>the left to filter.</div>';
  updateResetBtn();
}

/* ‚îÄ‚îÄ Apply filters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById('applyBtn').addEventListener('click',applyFilters);
async function applyFilters(){showOverlay('Querying‚Ä¶');await delay(30);try{_applyFilters();}catch(e){hideOverlay();alert('Query error: '+e.message);console.error(e);}}

function _applyFilters() {
  const clauses=[];
  for(const [col,f] of Object.entries(activeFilters)){
    if(f.type==='number'){
      if(f.min!==null) clauses.push(`"${col}" >= ${f.min}`);
      if(f.max!==null) clauses.push(`"${col}" <= ${f.max}`);
    } else {
      if(f.values.size===0){clauses.push('1=0');continue;}
      if(f.values.size<f.all.length){const inList=[...f.values].map(v=>`'${v.replace(/'/g,"''")}'`).join(',');clauses.push(`"${col}" IN (${inList})`);}
    }
  }
  const where=clauses.length?'WHERE '+clauses.join(' AND '):'';
  const sql=`SELECT "${geomColumn}" AS _gpkg_geom_, * FROM "${currentLayer}" ${where}`;
  let res; try{res=db.exec(sql);}catch(e){throw new Error(e.message+'\n'+sql);}

  if(!res.length||!res[0].values.length){clearMap();hideOverlay();document.getElementById('resultInfo').innerHTML='<strong>0</strong> features';currentFeatures=[];return;}

  const cols=res[0].columns; const geomIdx=cols.indexOf('_gpkg_geom_');
  let failed=0; const features=[];

  for(const row of res[0].values){
    const blob=row[geomIdx]; if(!blob){failed++;continue;}
    let geom; try{geom=parseGpkgGeom(blob);}catch(e){failed++;continue;}
    if(!geom){failed++;continue;}
    if(projTransform) try{reprojectGeom(geom);}catch(e){}
    const props={};
    for(let i=0;i<cols.length;i++){if(i===geomIdx)continue;const v=row[i];if(v instanceof Uint8Array||(v&&v.buffer instanceof ArrayBuffer))continue;props[cols[i]]=v;}
    const feat = {type:'Feature',geometry:geom,properties:props};
    feat._featureIdx = features.length;
    features.push(feat);
  }

  currentFeatures=features;
  renderGeoJSON({type:'FeatureCollection',features});
  document.getElementById('resultInfo').innerHTML=`<strong>${features.length}</strong> features${failed?` (${failed} skipped)`:''}`;
  hideOverlay();
  if(distCols.size>0) renderDistribution();
  rebuildTreeIfActive();
}

/* ‚îÄ‚îÄ Reproject ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function reprojectGeom(geom){
  function reproj(c){if(!c||!c.length)return;if(typeof c[0]==='number'){const[lng,lat]=projTransform.forward([c[0],c[1]]);c[0]=lng;c[1]=lat;}else c.forEach(reproj);}
  if(geom.coordinates)reproj(geom.coordinates);
  if(geom.geometries)geom.geometries.forEach(g=>reprojectGeom(g));
}

/* ‚îÄ‚îÄ WKB parser ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function parseGpkgGeom(input){
  let bytes;
  if(input instanceof Uint8Array)bytes=input;
  else if(Array.isArray(input))bytes=new Uint8Array(input);
  else if(ArrayBuffer.isView(input))bytes=new Uint8Array(input.buffer,input.byteOffset,input.byteLength);
  else if(input instanceof ArrayBuffer)bytes=new Uint8Array(input);
  else return null;
  if(bytes.length<8||bytes[0]!==0x47||bytes[1]!==0x50)return null;
  const flags=bytes[3]; if((flags>>4)&0x01)return null;
  const envN=(flags>>1)&0x07; const envCount=[0,4,6,6,8][envN]||0;
  const wkbStart=8+envCount*8; if(wkbStart>=bytes.length)return null;
  const wkbBuf=bytes.buffer.slice(bytes.byteOffset+wkbStart,bytes.byteOffset+bytes.length);
  const r=readWKB(new DataView(wkbBuf),0); return r?r.geom:null;
}
function readWKB(view,off){
  if(off+5>view.byteLength)return null;
  const le=view.getUint8(off)===1;off++;
  const rawType=view.getUint32(off,le);off+=4;
  const baseType=rawType%1000||(rawType&0xFFFF);
  const dimOffset=Math.floor(rawType/1000);
  const hasZ=!!(rawType&0x80000000)||dimOffset===1||dimOffset===3;
  const hasM=!!(rawType&0x40000000)||dimOffset===2||dimOffset===3;
  const extra=(hasZ?1:0)+(hasM?1:0);
  function readCoords(n){const a=[];for(let i=0;i<n;i++){const x=view.getFloat64(off,le);off+=8;const y=view.getFloat64(off,le);off+=8;off+=extra*8;a.push([x,y]);}return a;}
  switch(baseType){
    case 1:{const x=view.getFloat64(off,le);off+=8;const y=view.getFloat64(off,le);off+=8;off+=extra*8;return{geom:{type:'Point',coordinates:[x,y]},off};}
    case 2:{const n=view.getUint32(off,le);off+=4;return{geom:{type:'LineString',coordinates:readCoords(n)},off};}
    case 3:{const nr=view.getUint32(off,le);off+=4;const rings=[];for(let r=0;r<nr;r++){const n=view.getUint32(off,le);off+=4;rings.push(readCoords(n));}return{geom:{type:'Polygon',coordinates:rings},off};}
    case 4:{const n=view.getUint32(off,le);off+=4;const pts=[];for(let i=0;i<n;i++){const r=readWKB(view,off);if(!r)break;off=r.off;pts.push(r.geom.coordinates);}return{geom:{type:'MultiPoint',coordinates:pts},off};}
    case 5:{const n=view.getUint32(off,le);off+=4;const ls=[];for(let i=0;i<n;i++){const r=readWKB(view,off);if(!r)break;off=r.off;ls.push(r.geom.coordinates);}return{geom:{type:'MultiLineString',coordinates:ls},off};}
    case 6:{const n=view.getUint32(off,le);off+=4;const ps=[];for(let i=0;i<n;i++){const r=readWKB(view,off);if(!r)break;off=r.off;ps.push(r.geom.coordinates);}return{geom:{type:'MultiPolygon',coordinates:ps},off};}
    case 7:{const n=view.getUint32(off,le);off+=4;const gs=[];for(let i=0;i<n;i++){const r=readWKB(view,off);if(!r)break;off=r.off;gs.push(r.geom);}return{geom:{type:'GeometryCollection',geometries:gs},off};}
    default:return null;
  }
}

/* ‚îÄ‚îÄ Map rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function clearMap(){if(geojsonLayer){map.removeLayer(geojsonLayer);geojsonLayer=null;}}

function renderGeoJSON(fc){
  clearMap();
  geojsonLayer=L.geoJSON(fc,{
    style: f => {
      const idx = f._featureIdx;
      if (featureColorMap.size > 0 && idx !== undefined && featureColorMap.has(idx)) {
        const c = featureColorMap.get(idx);
        return { color:c, weight:1.2, opacity:.9, fillColor:c, fillOpacity: Math.min(1,geoFillOpacity+0.15) };
      }
      return {color:geoStroke,weight:1.5,opacity:.9,fillColor:geoFill,fillOpacity:geoFillOpacity};
    },
    pointToLayer:(f,latlng)=>{
      const idx = f._featureIdx;
      let c = geoFill, s = geoStroke;
      if (featureColorMap.size > 0 && idx !== undefined && featureColorMap.has(idx)) { c = s = featureColorMap.get(idx); }
      const marker = L.circleMarker(latlng,{radius:4,color:s,weight:1.5,fillColor:c,fillOpacity:Math.min(1,geoFillOpacity*3+0.1)});
      marker.options._featureIdx = idx;
      return marker;
    },
    onEachFeature:(f,layer)=>{
      // Store index for tree coloring updates
      layer.options._featureIdx = f._featureIdx;
      const props=f.properties||{};
      layer.on('mouseover',e=>{showTooltip(props,e.originalEvent.clientX,e.originalEvent.clientY);if(layer.setStyle)layer.setStyle({color:'#fff',weight:2,fillOpacity:Math.min(1,geoFillOpacity+.2)});});
      layer.on('mousemove',e=>positionTooltip(e.originalEvent.clientX,e.originalEvent.clientY));
      layer.on('mouseout',()=>{
        hideTooltip();
        // Restore tree color if active, else plain
        const idx = layer.options._featureIdx;
        if (featureColorMap.size > 0 && idx !== undefined && featureColorMap.has(idx)) {
          const c = featureColorMap.get(idx);
          if (layer.setStyle) layer.setStyle({color:c,fillColor:c,fillOpacity:Math.min(1,geoFillOpacity+0.15),weight:1.2,opacity:.9});
        } else {
          geojsonLayer.resetStyle(layer);
        }
      });
      const rows=Object.entries(props).map(([k,v])=>`<tr><td style="color:#546070;padding-right:8px;white-space:nowrap;vertical-align:top;max-width:180px;overflow:hidden;text-overflow:ellipsis">${escHtml(k)}</td><td style="word-break:break-word;max-width:260px">${escHtml(String(v??''))}</td></tr>`).join('');
      layer.bindPopup(`<div style="font-family:'JetBrains Mono',monospace;font-size:10px;min-width:300px;max-width:480px"><table style="border-collapse:collapse;width:100%">${rows}</table></div>`,{maxHeight:320,maxWidth:520});
    }
  }).addTo(map);
  try{const b=geojsonLayer.getBounds();if(b.isValid())map.fitBounds(b,{padding:[24,24],maxZoom:18});}catch(e){}
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   DISTRIBUTION PLOTS ‚Äî pure Canvas, no external lib
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function getNumericValues(colName) {
  return currentFeatures
    .map(f => f.properties[colName])
    .filter(v => v !== null && v !== undefined && !isNaN(Number(v)))
    .map(Number)
    .sort((a,b) => a-b);
}

function computeBoxStats(sorted) {
  const n = sorted.length;
  if (!n) return null;
  const q1 = percentile(sorted, 25);
  const q2 = percentile(sorted, 50);
  const q3 = percentile(sorted, 75);
  const iqr = q3-q1;
  const whiskerLo = Math.max(sorted[0], q1-1.5*iqr);
  const whiskerHi = Math.min(sorted[n-1], q3+1.5*iqr);
  const outliers = sorted.filter(v => v < whiskerLo || v > whiskerHi);
  return { min:sorted[0], max:sorted[n-1], q1, q2, q3, whiskerLo, whiskerHi, outliers, n };
}

function percentile(sorted, p) {
  const idx = (p/100)*(sorted.length-1);
  const lo  = Math.floor(idx), hi = Math.ceil(idx);
  return sorted[lo]+(sorted[hi]-sorted[lo])*(idx-lo);
}

function kernelDensity(sorted, bandwidth, pts) {
  // Silverman's rule if bandwidth not given
  const n = sorted.length;
  const std = Math.sqrt(sorted.reduce((s,v)=>{const m=sorted[Math.floor(n/2)];return s+(v-m)**2;},0)/n);
  const bw = bandwidth || 1.06*std*Math.pow(n,-0.2) || 1;
  return pts.map(x => {
    const sum = sorted.reduce((s,v) => s + Math.exp(-0.5*((x-v)/bw)**2), 0);
    return sum / (n*bw*Math.sqrt(2*Math.PI));
  });
}

function renderDistribution() {
  const body = document.getElementById('distBody');
  body.innerHTML = '';
  if (!currentFeatures.length || !distCols.size) return;

  const panelH = document.getElementById('distPanel').offsetHeight - 36;
  const plotW  = 172;  // wider for y-axis labels

  distCols.forEach(colName => {
    const sorted = getNumericValues(colName);
    if (!sorted.length) return;

    const wrap = document.createElement('div');
    wrap.className = 'plot-wrap';
    wrap.style.width  = plotW+'px';
    wrap.style.height = panelH+'px';

    const canvas = document.createElement('canvas');
    const dpr = window.devicePixelRatio||1;
    canvas.width  = plotW*dpr;
    canvas.height = panelH*dpr;
    canvas.style.width  = plotW+'px';
    canvas.style.height = panelH+'px';
    wrap.appendChild(canvas);

    const lbl = document.createElement('div');
    lbl.className = 'plot-label';
    lbl.textContent = colName;
    wrap.appendChild(lbl);

    body.appendChild(wrap);

    const ctx = canvas.getContext('2d');
    ctx.scale(dpr,dpr);

    // Left padding wide enough for axis labels; right padding for breathing room
    const pad = { top:16, bottom:28, left:48, right:10 };
    const cw = plotW, ch = panelH;
    const innerH = ch - pad.top - pad.bottom;
    const innerW = cw - pad.left - pad.right;

    ctx.clearRect(0, 0, cw, ch);

    const stats = computeBoxStats(sorted);
    if (!stats) return;

    const dataMin = stats.min, dataMax = stats.max;
    const dataRange = dataMax - dataMin || 1;
    function toY(v) { return pad.top + innerH * (1 - (v - dataMin) / dataRange); }

    // Theme-aware colors
    const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
    const gridCol  = isDark ? '#1a1f2a' : '#e0e4ec';
    const tickCol  = isDark ? '#2b3140' : '#c0c8d4';
    const axisCol  = isDark ? '#2b3140' : '#b0b8c8';
    const labelCol = isDark ? '#546070' : '#7a8898';

    // Vertical axis line
    ctx.strokeStyle = axisCol; ctx.lineWidth = 0.75;
    ctx.beginPath(); ctx.moveTo(pad.left, pad.top); ctx.lineTo(pad.left, ch - pad.bottom); ctx.stroke();

    // Y ticks + gridlines + value labels
    const tickCount = 5;
    ctx.font = '7.5px JetBrains Mono,monospace';
    for (let i = 0; i <= tickCount; i++) {
      const v = dataMin + (dataRange * i / tickCount);
      const y = toY(v);

      // Horizontal gridline
      ctx.strokeStyle = gridCol; ctx.lineWidth = 0.5;
      ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(cw - pad.right, y); ctx.stroke();

      // Tick mark
      ctx.strokeStyle = tickCol; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(pad.left - 4, y); ctx.lineTo(pad.left, y); ctx.stroke();

      // Value label right-aligned to the axis
      const absV = Math.abs(v);
      const fmtV = absV >= 100000 ? v.toExponential(1)
                 : absV >= 1000   ? v.toFixed(0)
                 : absV >= 10     ? v.toFixed(1)
                 : absV >= 0.1    ? v.toFixed(2)
                 :                  v.toExponential(1);
      ctx.fillStyle = labelCol; ctx.textAlign = 'right';
      ctx.fillText(fmtV, pad.left - 6, y + 2.5);
    }

    if (plotType === 'box') {
      drawBoxplot(ctx, stats, toY, pad, innerW, cw);
    } else {
      drawViolin(ctx, stats, sorted, toY, pad, innerW, cw, dataMin, dataMax, innerH);
    }

    // n= label near top
    ctx.fillStyle = labelCol; ctx.textAlign = 'center'; ctx.font = '7px JetBrains Mono,monospace';
    ctx.fillText(`n=${stats.n}`, pad.left + innerW / 2, pad.top + 8);
  });
}

function drawBoxplot(ctx, stats, toY, pad, innerW, cw) {
  const cx = pad.left + innerW / 2;   // centre of inner plot area
  const bw = Math.max(8, innerW * 0.28);

  // Whisker lines
  ctx.strokeStyle='#30f5c8'; ctx.lineWidth=1.5; ctx.setLineDash([2,2]);
  ctx.beginPath(); ctx.moveTo(cx, toY(stats.whiskerHi)); ctx.lineTo(cx, toY(stats.q3)); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx, toY(stats.q1)); ctx.lineTo(cx, toY(stats.whiskerLo)); ctx.stroke();
  ctx.setLineDash([]);

  // Whisker caps
  ctx.strokeStyle='#30f5c8'; ctx.lineWidth=1.5;
  [stats.whiskerHi, stats.whiskerLo].forEach(v => {
    const y = toY(v);
    ctx.beginPath(); ctx.moveTo(cx-bw*0.45, y); ctx.lineTo(cx+bw*0.45, y); ctx.stroke();
  });

  // IQR box
  const yQ1=toY(stats.q1), yQ3=toY(stats.q3);
  ctx.fillStyle='rgba(48,245,200,0.15)';
  ctx.strokeStyle='#30f5c8'; ctx.lineWidth=1.5;
  ctx.fillRect(cx-bw, yQ3, bw*2, yQ1-yQ3);
  ctx.strokeRect(cx-bw, yQ3, bw*2, yQ1-yQ3);

  // Median
  const yMed=toY(stats.q2);
  ctx.strokeStyle='#c8f530'; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(cx-bw, yMed); ctx.lineTo(cx+bw, yMed); ctx.stroke();

  // Outliers
  ctx.fillStyle='rgba(200,245,48,0.55)';
  stats.outliers.forEach(v => {
    const y = toY(v);
    ctx.beginPath(); ctx.arc(cx, y, 2.5, 0, Math.PI*2); ctx.fill();
  });
}

function drawViolin(ctx, stats, sorted, toY, pad, innerW, cw, dataMin, dataMax, innerH) {
  const cx = pad.left + innerW / 2;   // centre of inner plot area
  const pts = 60;
  const ys  = Array.from({length:pts}, (_,i) => dataMin + (dataMax-dataMin)*i/(pts-1));
  const density = kernelDensity(sorted, null, ys);
  const maxD = Math.max(...density) || 1;
  const vw = innerW * 0.44;

  // Violin shape
  ctx.beginPath();
  ctx.moveTo(cx, toY(ys[0]));
  ys.forEach((v, i) => ctx.lineTo(cx + (density[i]/maxD)*vw, toY(v)));
  for (let i = pts-1; i >= 0; i--) ctx.lineTo(cx - (density[i]/maxD)*vw, toY(ys[i]));
  ctx.closePath();
  ctx.fillStyle='rgba(48,245,200,0.15)'; ctx.fill();
  ctx.strokeStyle='rgba(48,245,200,0.6)'; ctx.lineWidth=1; ctx.stroke();

  // IQR bar
  ctx.strokeStyle='rgba(200,245,48,0.6)'; ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(cx, toY(stats.q1)); ctx.lineTo(cx, toY(stats.q3)); ctx.stroke();

  // Median tick
  const yMed = toY(stats.q2);
  ctx.strokeStyle='#c8f530'; ctx.lineWidth=2.5;
  ctx.beginPath(); ctx.moveTo(cx-7, yMed); ctx.lineTo(cx+7, yMed); ctx.stroke();
}

/* ‚îÄ‚îÄ Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function escHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function escAttr(s){return String(s).replace(/[^a-zA-Z0-9_]/g,'_');}
function delay(ms){return new Promise(r=>setTimeout(r,ms));}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   INTERACTIVE SVG DENDROGRAM
   Left‚Üíright layout: root left, leaves right
   Bezier curved edges colored by branch hue sector
   Click any node to collapse/expand its subtree
   Node radius ‚àù sqrt(feature count)
   Pan (drag background) + Zoom (wheel)
   Leaf node colors ‚Üí map feature colors
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

let treeLevels = [];
let treeRoot   = null;
let featureColorMap = new Map();
const TREE_MAX_VALS = 40;
let treeOrientation = 'H'; // 'H' = left‚Üíright, 'V' = top‚Üídown

let treeVB = { x: 0, y: 0, w: 600, h: 400 };
let _panOrigin = null;

// Orientation toggle
document.getElementById('treeOrientH').addEventListener('click', () => {
  treeOrientation = 'H';
  document.getElementById('treeOrientH').classList.add('active');
  document.getElementById('treeOrientV').classList.remove('active');
  if (treeRoot) drawDendrogram();
});
document.getElementById('treeOrientV').addEventListener('click', () => {
  treeOrientation = 'V';
  document.getElementById('treeOrientV').classList.add('active');
  document.getElementById('treeOrientH').classList.remove('active');
  if (treeRoot) drawDendrogram();
});

// ‚îÄ‚îÄ Resize panel handle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function () {
  const h = document.getElementById('rHandleV3');
  const panel = document.getElementById('treePanel');
  let drag = false, sx, sw;
  h.addEventListener('mousedown', e => { drag = true; sx = e.clientX; sw = panel.offsetWidth; h.classList.add('active'); document.body.style.cursor = 'col-resize'; e.preventDefault(); });
  document.addEventListener('mousemove', e => { if (!drag) return; panel.style.width = Math.min(700, Math.max(220, sw - (e.clientX - sx))) + 'px'; if (treeRoot) drawDendrogram(); });
  document.addEventListener('mouseup', () => { if (!drag) return; drag = false; h.classList.remove('active'); document.body.style.cursor = ''; map.invalidateSize(); });
})();

// ‚îÄ‚îÄ SVG pan & zoom ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _svgWrap = document.getElementById('treeSvgWrap');
_svgWrap.addEventListener('mousedown', e => {
  if (e.button !== 0 || e.target.closest('.node-g')) return;
  _panOrigin = { cx: e.clientX, cy: e.clientY, ox: treeVB.x, oy: treeVB.y };
});
document.addEventListener('mousemove', e => {
  if (!_panOrigin) return;
  const svg = document.getElementById('treeSvg');
  const scaleX = treeVB.w / (svg.clientWidth || 1);
  const scaleY = treeVB.h / (svg.clientHeight || 1);
  treeVB.x = _panOrigin.ox - (e.clientX - _panOrigin.cx) * scaleX;
  treeVB.y = _panOrigin.oy - (e.clientY - _panOrigin.cy) * scaleY;
  svg.setAttribute('viewBox', `${treeVB.x} ${treeVB.y} ${treeVB.w} ${treeVB.h}`);
});
document.addEventListener('mouseup', () => { _panOrigin = null; });
_svgWrap.addEventListener('wheel', e => {
  e.preventDefault();
  const svg = document.getElementById('treeSvg');
  const rect = svg.getBoundingClientRect();
  const px = (e.clientX - rect.left) / rect.width;
  const py = (e.clientY - rect.top) / rect.height;
  const f = e.deltaY > 0 ? 1.18 : 0.847;
  const nw = treeVB.w * f, nh = treeVB.h * f;
  treeVB.x += (treeVB.w - nw) * px;
  treeVB.y += (treeVB.h - nh) * py;
  treeVB.w = nw; treeVB.h = nh;
  svg.setAttribute('viewBox', `${treeVB.x} ${treeVB.y} ${treeVB.w} ${treeVB.h}`);
}, { passive: false });

document.getElementById('treeFitBtn').addEventListener('click', () => {
  const svg = document.getElementById('treeSvg');
  const tw = +svg.getAttribute('data-tw') || 600;
  const th = +svg.getAttribute('data-th') || 400;
  treeVB = { x: 0, y: 0, w: tw, h: th };
  svg.setAttribute('viewBox', `0 0 ${tw} ${th}`);
});

// ‚îÄ‚îÄ Tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const _treeTip = (() => {
  const d = document.createElement('div');
  d.style.cssText = 'position:fixed;z-index:3000;background:var(--panel2);border:1px solid var(--border2);border-radius:3px;padding:4px 7px;font-family:JetBrains Mono,monospace;font-size:10px;color:var(--text);pointer-events:none;display:none;max-width:200px;line-height:1.5;box-shadow:0 4px 12px rgba(0,0,0,.4)';
  document.body.appendChild(d);
  return d;
})();
function showTreeTip(html, x, y) {
  _treeTip.innerHTML = html;
  _treeTip.style.display = 'block';
  const W = window.innerWidth, H = window.innerHeight;
  let lx = x + 12, ly = y + 12;
  if (lx + 210 > W) lx = x - 210;
  if (ly + 80 > H) ly = y - 80;
  _treeTip.style.left = lx + 'px'; _treeTip.style.top = ly + 'px';
}
function hideTreeTip() { _treeTip.style.display = 'none'; }

// ‚îÄ‚îÄ Column picker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function treePopulatePicker() {
  const sel = document.getElementById('treeColPicker');
  const used = new Set(treeLevels.map(l => l.colName));
  const avail = columns.filter(c => !used.has(c.name));
  sel.innerHTML = '<option value="">‚Äî select column ‚Äî</option>' +
    avail.map(c => `<option value="${escHtml(c.name)}">${escHtml(c.name)}</option>`).join('');
}

document.getElementById('treeAddLevelBtn').addEventListener('click', () => {
  const sel = document.getElementById('treeColPicker');
  const colName = sel.value;
  if (!colName || !db) return;
  let nDistinct = 0;
  try { const r = db.exec(`SELECT COUNT(DISTINCT "${colName}") FROM "${currentLayer}"`); if (r.length) nDistinct = r[0].values[0][0]; } catch (e) {}
  const warn = document.getElementById('treeMaxValWarn');
  if (nDistinct > TREE_MAX_VALS) { warn.textContent = `\u26a0 ${nDistinct} distinct values \u2014 max is ${TREE_MAX_VALS}`; return; }
  warn.textContent = '';
  treeLevels.push({ colName });
  renderLevelChips(); treePopulatePicker(); buildTree();
});

document.getElementById('treeClearBtn').addEventListener('click', () => {
  treeLevels = []; treeRoot = null; featureColorMap.clear();
  renderLevelChips(); treePopulatePicker();
  const svg = document.getElementById('treeSvg');
  svg.innerHTML = ''; svg.removeAttribute('width'); svg.removeAttribute('height');
  document.getElementById('treeEmptyMsg').style.display = 'flex';
  document.getElementById('treeLegendBar').style.display = 'none';
  document.getElementById('treeFitBtn').style.display = 'none';
  document.getElementById('treeClearBtn').style.display = 'none';
  if (geojsonLayer) geojsonLayer.setStyle(() => ({ color: geoStroke, fillColor: geoFill, fillOpacity: geoFillOpacity, weight: 1.5, opacity: .9 }));
});

function renderLevelChips() {
  const list = document.getElementById('treeLevelList');
  list.innerHTML = treeLevels.map((l, i) => `
    <span class="tree-level-chip">
      <span class="lc-num">L${i + 1}</span>${escHtml(l.colName)}
      <span class="lc-rm" data-i="${i}">\xd7</span>
    </span>`).join('');
  list.querySelectorAll('.lc-rm').forEach(btn => btn.addEventListener('click', () => {
    treeLevels.splice(+btn.dataset.i, 1);
    renderLevelChips(); treePopulatePicker();
    if (treeLevels.length) buildTree(); else document.getElementById('treeClearBtn').click();
  }));
  const has = treeLevels.length > 0;
  document.getElementById('treeClearBtn').style.display = has ? 'inline-block' : 'none';
  document.getElementById('treeFitBtn').style.display = has ? 'inline-block' : 'none';
}

// ‚îÄ‚îÄ Build data tree ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTree() {
  if (!currentFeatures.length || !treeLevels.length) return;
  featureColorMap.clear();

  function makeNode(indices, depth, value) {
    const colName = depth < treeLevels.length ? treeLevels[depth].colName : null;
    const node = { value, colName, children: [], featureIndices: indices, color: '#888', collapsed: false, depth };
    if (colName) {
      const groups = new Map();
      indices.forEach(idx => {
        const v = String(currentFeatures[idx].properties[colName] ?? '\u2205');
        if (!groups.has(v)) groups.set(v, []);
        groups.get(v).push(idx);
      });
      [...groups.entries()]
        .sort((a, b) => a[0].localeCompare(b[0], undefined, { numeric: true }))
        .forEach(([val, arr]) => node.children.push(makeNode(arr, depth + 1, val)));
    }
    return node;
  }

  treeRoot = makeNode(currentFeatures.map((_, i) => i), 0, 'ALL');
  _colorTree(treeRoot, 0, 1);
  _buildColorMap(treeRoot);
  drawDendrogram();
  applyTreeColoring();
  renderTreeLegend();
  document.getElementById('treeEmptyMsg').style.display = 'none';
}

// ‚îÄ‚îÄ Colors: hue sector per subtree ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _colorTree(node, hStart, hRange) {
  if (node.collapsed || node.children.length === 0) {
    node.color = `hsl(${((hStart + hRange / 2) * 360).toFixed(1)},75%,60%)`;
    return;
  }
  node.color = `hsl(${((hStart + hRange / 2) * 360).toFixed(1)},35%,38%)`;
  const n = node.children.length;
  node.children.forEach((c, i) => _colorTree(c, hStart + hRange * i / n, hRange / n));
}

function _buildColorMap(node) {
  if (node.collapsed || node.children.length === 0) {
    node.featureIndices.forEach(idx => featureColorMap.set(idx, node.color)); return;
  }
  node.children.forEach(_buildColorMap);
}

// ‚îÄ‚îÄ Layout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function _leafCount(node) {
  if (node.collapsed || node.children.length === 0) return 1;
  return node.children.reduce((s, c) => s + _leafCount(c), 0);
}
function _maxDepth(node) {
  if (node.collapsed || node.children.length === 0) return node.depth;
  return Math.max(...node.children.map(_maxDepth));
}
function _assignLeafY(node, leafList) {
  if (node.collapsed || node.children.length === 0) {
    node._leafIdx = leafList.length; leafList.push(node); return;
  }
  node.children.forEach(c => _assignLeafY(c, leafList));
}
function _assignNodeY(node, nLeaves, rowH, padT) {
  if (node.collapsed || node.children.length === 0) {
    node._py = padT + (node._leafIdx + 0.5) * rowH; return;
  }
  node.children.forEach(c => _assignNodeY(c, nLeaves, rowH, padT));
  node._py = node.children.reduce((s, c) => s + c._py, 0) / node.children.length;
}

// ‚îÄ‚îÄ Draw SVG dendrogram ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawDendrogram() {
  const svg = document.getElementById('treeSvg');
  svg.innerHTML = '';
  if (!treeRoot) return;

  _colorTree(treeRoot, 0, 1);
  featureColorMap.clear();
  _buildColorMap(treeRoot);

  const leafList = [];
  _assignLeafY(treeRoot, leafList);
  const nL = leafList.length;
  const td = _maxDepth(treeRoot);

  // Read CSS theme vars for SVG colors
  const cs = getComputedStyle(document.documentElement);
  const T = {
    bg:      cs.getPropertyValue('--svg-bg').trim()   || '#0d0f12',
    grid:    cs.getPropertyValue('--svg-grid').trim() || '#191e28',
    hdr:     cs.getPropertyValue('--svg-hdr').trim()  || '#2a3445',
    lblLeaf: cs.getPropertyValue('--lbl-leaf').trim() || '#cdd8e8',
    lblInt:  cs.getPropertyValue('--lbl-int').trim()  || '#6a7e94',
    cntClr:  cs.getPropertyValue('--cnt-clr').trim()  || '#344455',
    nodeInt: cs.getPropertyValue('--node-int').trim() || '#171c25',
    nodeRt:  cs.getPropertyValue('--node-root').trim()|| '#111620',
  };

  const isV = treeOrientation === 'V';

  if (isV) {
    // ‚îÄ‚îÄ VERTICAL: root top, leaves bottom ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PAD = { t: 50, r: 20, b: 80, l: 20 };
    const colH = Math.max(60, Math.min(120, 480 / Math.max(td + 1, 2)));
    const colW_v = Math.max(18, Math.min(40, 500 / Math.max(nL, 1)));
    const cW = PAD.l + nL * colW_v + PAD.r;
    const cH = PAD.t + td * colH + PAD.b;

    svg.setAttribute('width', cW); svg.setAttribute('height', cH);
    svg.setAttribute('data-tw', cW); svg.setAttribute('data-th', cH);
    treeVB = { x: 0, y: 0, w: cW, h: cH };
    svg.setAttribute('viewBox', `0 0 ${cW} ${cH}`);

    _assignNodeY(treeRoot, nL, colW_v, PAD.l);

    // node coords: X from _py (leaf positions), Y from depth
    const nx_v = node => node._py;                       // horizontal = leaf position
    const ny_v = node => PAD.t + node.depth * colH;      // vertical = depth

    svg.appendChild(S('rect', { x: 0, y: 0, width: cW, height: cH, fill: T.bg }));

    // Depth level dividers + full column name labels (right side)
    // Measure longest name to set label column width
    const LBL_FONT_SZ = 8, LBL_CH_W = 4.8, LBL_PAD_R = 6;
    const maxLblW = Math.max(...treeLevels.map(l => l.colName.length * LBL_CH_W), 20);

    for (let d = 0; d <= td; d++) {
      const cy = PAD.t + d * colH;
      if (d > 0) {
        svg.appendChild(S('line', { x1: 0, y1: cy - colH * 0.5, x2: cW, y2: cy - colH * 0.5, stroke: T.grid, 'stroke-width': 1 }));
      }
      const colLabel = d < treeLevels.length ? treeLevels[d].colName : 'leaf';
      // Multiline wrap: break into chunks of ~14 chars at word boundaries
      const words = colLabel.split(/(?=[_\-. ])|(?<=[_\-. ])/);
      const lines = [];
      let cur = '';
      for (const w of words) {
        if ((cur + w).length > 16 && cur.length > 0) { lines.push(cur.trim()); cur = w; }
        else cur += w;
      }
      if (cur.trim()) lines.push(cur.trim());
      const lineH = LBL_FONT_SZ + 1.5;
      const totalH = lines.length * lineH;
      const startY = cy - totalH / 2 + lineH / 2;
      lines.forEach((line, li) => {
        const t = S('text', { x: cW - LBL_PAD_R, y: startY + li * lineH, 'text-anchor': 'end', 'font-size': LBL_FONT_SZ, fill: T.hdr, 'dominant-baseline': 'central', 'font-family': 'JetBrains Mono,monospace' });
        t.textContent = line;
        svg.appendChild(t);
      });
    }

    const edgeG = S('g', {}); svg.appendChild(edgeG);
    const nodeG = S('g', {}); svg.appendChild(nodeG);

    function drawV(node, parentNode) {
      const x = nx_v(node), y = ny_v(node);
      const isLeaf = node.collapsed || node.children.length === 0;
      const isRoot = node.depth === 0;
      const frac = node.featureIndices.length / Math.max(1, currentFeatures.length);
      const r = Math.max(4, Math.min(11, 4 + frac * 28));
      const sw = Math.max(0.8, Math.min(3, 0.8 + Math.log10(Math.max(2, node.featureIndices.length)) * 0.6));

      if (parentNode) {
        const px = nx_v(parentNode), py = ny_v(parentNode);
        const my = (py + y) / 2;
        edgeG.appendChild(S('path', {
          d: `M${px},${py} C${px},${my} ${x},${my} ${x},${y}`,
          fill: 'none', stroke: node.color, 'stroke-width': sw,
          opacity: isLeaf ? 0.9 : 0.5, 'stroke-linecap': 'round'
        }));
        // (level name shown in column header, not on edge)
      }

      const g = S('g', { class: 'node-g', transform: `translate(${x},${y})` });
      if (isLeaf) g.appendChild(S('circle', { r: r + 4, fill: node.color, opacity: 0.1 }));
      const circle = S('circle', { class: 'node-circle', r, fill: isLeaf ? node.color : (isRoot ? T.nodeRt : T.nodeInt), stroke: node.color, 'stroke-width': isLeaf ? 0 : 1.8, opacity: isLeaf ? 0.93 : 0.82 });
      g.appendChild(circle);
      if (node.collapsed && node.children.length > 0) {
        const ch = S('text', { x: 0, y: r + 9, 'text-anchor': 'middle', 'font-size': 7, fill: node.color, opacity: 0.9, 'pointer-events': 'none' });
        ch.textContent = '‚ñº'; g.appendChild(ch);
      }
      const raw = isRoot ? `ALL n=${node.featureIndices.length}` : String(node.value);
      const txt = raw.length > 12 ? raw.slice(0, 11) + '‚Ä¶' : raw;
      const lbl = S('text', { x: 0, y: r + 11, 'text-anchor': 'middle', 'dominant-baseline': 'hanging', 'font-size': isLeaf ? 9 : 8, fill: isLeaf ? T.lblLeaf : T.lblInt, 'pointer-events': 'none', 'font-family': 'JetBrains Mono,monospace' });
      lbl.textContent = txt; g.appendChild(lbl);
      if (!isRoot && !isLeaf) {
        const cnt = S('text', { x: 0, y: r + 21, 'text-anchor': 'middle', 'dominant-baseline': 'hanging', 'font-size': 7, fill: T.cntClr, 'pointer-events': 'none', 'font-family': 'JetBrains Mono,monospace' });
        cnt.textContent = `n=${node.featureIndices.length}`; g.appendChild(cnt);
      }

      const tipHtml = () =>
        `<strong style="color:${node.color}">${escHtml(String(node.value))}</strong><br>` +
        `<span style="color:var(--muted)">${node.featureIndices.length} features ¬∑ depth ${node.depth}</span>` +
        (node.children.length > 0 ? `<br><span style="color:var(--accent2);font-size:9px">${node.collapsed ? 'Click to expand' : 'Click to collapse'}</span>` : '');
      g.addEventListener('mouseenter', e => { circle.setAttribute('opacity', 1); showTreeTip(tipHtml(), e.clientX, e.clientY); });
      g.addEventListener('mousemove', e => showTreeTip(tipHtml(), e.clientX, e.clientY));
      g.addEventListener('mouseleave', () => { circle.setAttribute('opacity', isLeaf ? 0.93 : 0.82); hideTreeTip(); });
      if (node.children.length > 0) {
        g.style.cursor = 'pointer';
        g.addEventListener('click', e => {
          e.stopPropagation(); hideTreeTip();
          node.collapsed = !node.collapsed;
          _colorTree(treeRoot, 0, 1); featureColorMap.clear(); _buildColorMap(treeRoot);
          drawDendrogram(); applyTreeColoring(); renderTreeLegend();
        });
      }
      nodeG.appendChild(g);
      if (!node.collapsed) node.children.forEach(c => drawV(c, node));
    }
    drawV(treeRoot, null);

  } else {
    // ‚îÄ‚îÄ HORIZONTAL: root left, leaves right ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PAD = { r: 130, b: 16, l: 20 };
    const rowH = Math.max(16, Math.min(30, 480 / Math.max(nL, 1)));
    const colW = Math.max(70, Math.min(150, 560 / Math.max(td + 1, 2)));

    // Pre-compute header height (depends on longest column name and colW)
    const LBL_LINE_H_PRE = 10;
    const maxLinesPre = Math.max(1, ...treeLevels.map(l => {
      const words = l.colName.split(/[_\-. ]/g).filter(Boolean);
      const charsPerLine = Math.max(8, Math.floor(colW / 5.5));
      let cur='', cnt=1;
      for (const w of words) { if (cur.length > 0 && (cur+w).length > charsPerLine) { cnt++; cur=w; } else cur=(cur?cur+'_':'')+w; }
      return cnt;
    }));
    const hdrHPre = Math.max(22, maxLinesPre * LBL_LINE_H_PRE + 6);

    const cW = PAD.l + td * colW + PAD.r;
    const cH = hdrHPre + nL * rowH + PAD.b;

    svg.setAttribute('width', cW); svg.setAttribute('height', cH);
    svg.setAttribute('data-tw', cW); svg.setAttribute('data-th', cH);
    treeVB = { x: 0, y: 0, w: cW, h: cH };
    svg.setAttribute('viewBox', `0 0 ${cW} ${cH}`);

    _assignNodeY(treeRoot, nL, rowH, hdrHPre);

    const nx = node => PAD.l + node.depth * colW;
    const ny = node => node._py;

    svg.appendChild(S('rect', { x: 0, y: 0, width: cW, height: cH, fill: T.bg }));

    // Depth column dividers + full column name labels (top row, multiline wrapped)
    const LBL_FONT_SZ_H = 8, LBL_LINE_H = 10;
    // Compute header row height needed for longest name
    const maxLines = Math.max(1, ...treeLevels.map(l => {
      const words = l.colName.split(/(?=[_\-. ])|(?<=[_\-. ])/);
      let cur='', cnt=1;
      for (const w of words) { if ((cur+w).length > Math.floor(colW/5.5) && cur.length > 0) { cnt++; cur=w; } else cur+=w; }
      return cnt;
    }));
    const hdrH = Math.max(22, maxLines * LBL_LINE_H + 6);

    for (let d = 0; d <= td; d++) {
      const cx = PAD.l + d * colW;
      if (d > 0) svg.appendChild(S('line', { x1: cx - colW * 0.5, y1: 0, x2: cx - colW * 0.5, y2: cH, stroke: T.grid, 'stroke-width': 1 }));
      const label = d < treeLevels.length ? treeLevels[d].colName : 'leaf';
      const charsPerLine = Math.max(8, Math.floor(colW / 5.5));
      const words = label.split(/(?=[_\-. ])|(?<=[_\-. ])/);
      const lines = [];
      let cur = '';
      for (const w of words) {
        if ((cur + w).length > charsPerLine && cur.length > 0) { lines.push(cur.trim()); cur = w; }
        else cur += w;
      }
      if (cur.trim()) lines.push(cur.trim());
      const totalH = lines.length * LBL_LINE_H;
      const startY = hdrH / 2 - totalH / 2 + LBL_LINE_H / 2;
      lines.forEach((line, li) => {
        const t = S('text', { x: cx, y: startY + li * LBL_LINE_H, 'text-anchor': 'middle', 'font-size': LBL_FONT_SZ_H, fill: T.hdr, 'dominant-baseline': 'central', 'font-family': 'JetBrains Mono,monospace' });
        t.textContent = line;
        svg.appendChild(t);
      });
    }
    // Horizontal separator under header
    svg.appendChild(S('line', { x1: 0, y1: hdrH, x2: cW, y2: hdrH, stroke: T.grid, 'stroke-width': 1 }));

    const edgeG = S('g', {}); svg.appendChild(edgeG);
    const nodeG = S('g', {}); svg.appendChild(nodeG);

    function draw(node, parentNode) {
      const x = nx(node), y = ny(node);
      const isLeaf = node.collapsed || node.children.length === 0;
      const isRoot = node.depth === 0;
      const frac = node.featureIndices.length / Math.max(1, currentFeatures.length);
      const r = Math.max(4, Math.min(12, 4 + frac * 30));
      const sw = Math.max(0.8, Math.min(3, 0.8 + Math.log10(Math.max(2, node.featureIndices.length)) * 0.6));

      if (parentNode) {
        const px = nx(parentNode), py = ny(parentNode);
        const mx = (px + x) / 2;
        edgeG.appendChild(S('path', {
          d: `M${px},${py} C${mx},${py} ${mx},${y} ${x},${y}`,
          fill: 'none', stroke: node.color, 'stroke-width': sw,
          opacity: isLeaf ? 0.9 : 0.5, 'stroke-linecap': 'round'
        }));
        // (level name shown in column header, not on edge)
      }

      const g = S('g', { class: 'node-g', transform: `translate(${x},${y})` });
      if (isLeaf) g.appendChild(S('circle', { r: r + 5, fill: node.color, opacity: 0.1 }));
      const circle = S('circle', { class: 'node-circle', r, fill: isLeaf ? node.color : (isRoot ? T.nodeRt : T.nodeInt), stroke: node.color, 'stroke-width': isLeaf ? 0 : 1.8, opacity: isLeaf ? 0.93 : 0.82 });
      g.appendChild(circle);
      if (node.collapsed && node.children.length > 0) {
        const ch = S('text', { x: r + 3, y: 0, 'text-anchor': 'start', 'dominant-baseline': 'central', 'font-size': 7, fill: node.color, opacity: 0.9, 'pointer-events': 'none' });
        ch.textContent = '‚ñ∂'; g.appendChild(ch);
      }
      const raw = isRoot ? `ALL  n=${node.featureIndices.length}` : String(node.value);
      const txt = raw.length > 17 ? raw.slice(0, 16) + '‚Ä¶' : raw;
      const lbl = S('text', { x: r + 6, y: 0, 'text-anchor': 'start', 'dominant-baseline': 'central', 'font-size': isRoot ? 8 : 9, fill: isLeaf ? T.lblLeaf : T.lblInt, 'pointer-events': 'none', 'font-family': 'JetBrains Mono,monospace' });
      lbl.textContent = txt; g.appendChild(lbl);
      if (!isRoot && !isLeaf) {
        const cnt = S('text', { x: r + 6, y: 10, 'text-anchor': 'start', 'font-size': 7.5, fill: T.cntClr, 'pointer-events': 'none', 'font-family': 'JetBrains Mono,monospace' });
        cnt.textContent = `n=${node.featureIndices.length}`; g.appendChild(cnt);
      }

      const tipHtml = () =>
        `<strong style="color:${node.color}">${escHtml(String(node.value))}</strong><br>` +
        `<span style="color:var(--muted)">${node.featureIndices.length} features ¬∑ depth ${node.depth}</span>` +
        (node.children.length > 0 ? `<br><span style="color:var(--accent2);font-size:9px">${node.collapsed ? 'Click to expand' : 'Click to collapse'}</span>` : '');
      g.addEventListener('mouseenter', e => { circle.setAttribute('opacity', 1); showTreeTip(tipHtml(), e.clientX, e.clientY); });
      g.addEventListener('mousemove', e => showTreeTip(tipHtml(), e.clientX, e.clientY));
      g.addEventListener('mouseleave', () => { circle.setAttribute('opacity', isLeaf ? 0.93 : 0.82); hideTreeTip(); });
      if (node.children.length > 0) {
        g.style.cursor = 'pointer';
        g.addEventListener('click', e => {
          e.stopPropagation(); hideTreeTip();
          node.collapsed = !node.collapsed;
          _colorTree(treeRoot, 0, 1); featureColorMap.clear(); _buildColorMap(treeRoot);
          drawDendrogram(); applyTreeColoring(); renderTreeLegend();
        });
      }
      nodeG.appendChild(g);
      if (!node.collapsed) node.children.forEach(c => draw(c, node));
    }
    draw(treeRoot, null);
  }
}

// ‚îÄ‚îÄ SVG element factory ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function S(tag, attrs) {
  const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
  Object.entries(attrs).forEach(([k, v]) => el.setAttribute(k, v));
  return el;
}

// ‚îÄ‚îÄ Apply colors to Leaflet map ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyTreeColoring() {
  if (!geojsonLayer) return;
  geojsonLayer.eachLayer(layer => {
    const idx = layer.options._featureIdx;
    if (idx === undefined) return;
    const c = featureColorMap.get(idx) || '#888';
    if (typeof layer.setStyle === 'function')
      layer.setStyle({ color: c, fillColor: c, fillOpacity: Math.min(1, geoFillOpacity + 0.15), weight: 1.2, opacity: 0.9 });
  });
}

// ‚îÄ‚îÄ Legend ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTreeLegend() {
  const bar = document.getElementById('treeLegendBar');
  const items = document.getElementById('treeLegendItems');
  if (!treeRoot || featureColorMap.size === 0) { bar.style.display = 'none'; return; }
  const leaves = [];
  function collect(node, path) {
    if (node.collapsed || node.children.length === 0) { leaves.push({ color: node.color, label: path || 'All', n: node.featureIndices.length, node }); return; }
    node.children.forEach(c => collect(c, (path ? path + ' \u203a ' : '') + String(c.value)));
  }
  collect(treeRoot, '');
  document.getElementById('treeLegendCount').textContent = leaves.length;
  bar.style.display = 'flex'; items.innerHTML = '';
  leaves.forEach(({ color, label, n, node: ln }) => {
    const item = document.createElement('div');
    item.className = 'tli'; item.title = `${label}  (n=${n})`;
    item.innerHTML = `<span class="tli-sw" style="background:${color}"></span><span class="tli-lbl">${escHtml(label)}</span>`;
    item.addEventListener('mouseenter', () => {
      if (!geojsonLayer) return;
      const hi = new Set(ln.featureIndices);
      geojsonLayer.eachLayer(layer => {
        const idx = layer.options._featureIdx;
        if (layer.setStyle) layer.setStyle(hi.has(idx)
          ? { color: '#fff', weight: 2.5, fillOpacity: Math.min(1, geoFillOpacity + 0.35) }
          : { opacity: 0.08, fillOpacity: 0.02 });
      });
    });
    item.addEventListener('mouseleave', applyTreeColoring);
    items.appendChild(item);
  });
}

// ‚îÄ‚îÄ Rebuild on feature update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function rebuildTreeIfActive() {
  if (treeLevels.length > 0 && treeRoot) buildTree();
  else if (treeLevels.length > 0) treePopulatePicker();
}

</script>
</body>
</html>
